apiVersion: v1
kind: Pod
metadata:
  name: {{ template "send-recv-plasma-leap.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: emu-recv
spec:
  restartPolicy: {{ .Values.pod.restartPolicy }}
  terminationGracePeriodSeconds: {{ .Values.pod.terminationGracePeriodSeconds }}

  hostname: {{ template "send-recv-plasma-leap.fullname" . }}
  volumes:
  - name: shared-mem
    emptyDir:
      medium: Memory
  - name: shared-plasma
    emptyDir: {}
  - name: shared-logs
    hostPath:
      type: Directory
      path: /mnt/msdata/log
  - name: in-data
    {{ .Values.input.mountType }}:
    {{- with .Values.input.mountTypeOptions }}
      {{- toYaml . | nindent 10 }}
    {{- end }}
  - name: out-data
    {{ .Values.output.mountType }}:
    {{- with .Values.output.mountTypeOptions }}
      {{- toYaml . | nindent 10 }}
    {{- end }}

  containers:
  - name: plasma-store
    image: ska-sdp-receive-leap
    imagePullPolicy: Never
    volumeMounts:
      - name: shared-mem
        mountPath: /dev/shm
      - name: shared-plasma
        mountPath: {{ .Values.plasma_store.mountPath }}
      - name: shared-logs
        mountPath: /tmp/log
      - name: in-data
        mountPath: {{ .Values.input.mountPath }}
    command: ['/bin/bash']
    args: ['-c', 'plasma_store -s {{ .Values.plasma_store.plasmaSocket }} -m 200000000 &> /tmp/log/{{ .Values.logName }}-plasma-store.log']
    terminationMessagePath: '/tmp/log/{{ .Values.logName }}-plasma-store.log'

  - name: plasma-mswriter
    image: {{ .Values.plasma_mswriter.image }}
    imagePullPolicy: Never
    #resources:
    #  limits:
    #    nvidia.com/gpu: 1
    workingDir: {{ .Values.input.dataPath }}
    env:
    - name: MS_OUTPUT_PATH
      value: {{ .Values.output.mountPath }}/{{ .Values.plasma_mswriter.ms_output_name }}
    - name: PROCESSOR_COMMAND
      value: {{ .Values.leap_cli.command }} -c {{ .Values.leap_cli.config }} -f %s
    volumeMounts:
    - name: shared-mem
      mountPath: /dev/shm
    - name: shared-plasma
      mountPath: {{ .Values.plasma_store.mountPath }}
    - name: shared-logs
      mountPath: /tmp/log
    - name: in-data
      mountPath: {{ .Values.input.mountPath }}
    - name: out-data
      mountPath: {{ .Values.output.mountPath }}
    command: ["/bin/bash"]
    args: ["-c", "plasma-mswriter $MS_OUTPUT_PATH -s {{ .Values.plasma_store.plasmaSocket }} --use_plasma_ms 1 --max_payloads 1 --max_ms 1 &> /tmp/log/{{ .Values.logName }}-plasma-mswriter.log"]

  - name: emu-recv
    image: {{ .Values.emu_recv.image }}
    imagePullPolicy: Never
    workingDir: {{ .Values.input.dataPath }}
    volumeMounts:
    - name: shared-plasma
      mountPath: {{ .Values.plasma_store.mountPath }}
    - name: shared-logs
      mountPath: /tmp/log
    - name: in-data
      mountPath: {{ .Values.input.mountPath }}
    - name: out-data
      mountPath: {{ .Values.output.mountPath }}
    env:
    - name: SPEAD2_CONFIG_PATH
      value: {{ .Values.input.spead2Config }}
    command: ["/bin/bash"]
    args: ["-c", "emu-recv -c ${SPEAD2_CONFIG_PATH} &> /tmp/log/{{ .Values.logName }}-emu-recv.log"]
    terminationMessagePath: '/tmp/log/{{ .Values.logName }}-emu-recv.log'
